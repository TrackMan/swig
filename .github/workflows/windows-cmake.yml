name: windows-cmake

on:
  push:
    paths-ignore:
      - 'CHANGES*'
      - 'Doc/**'
      - 'Tools/CI-linux-*'
      - 'Tools/GHA-linux-*'
      - 'appveyor.yml'
  pull_request:
    branches: master
    paths-ignore:
      - 'CHANGES*'
      - 'Doc/**'
      - 'Tools/CI-linux-*'
      - 'Tools/GHA-linux-*'
      - 'appveyor.yml'

permissions:
  contents: read
  id-token: write  # Required for OIDC authentication

jobs:
  cmake:
    runs-on: ${{ matrix.os }}
    environment: Development
    name: CMake VS ${{ matrix.VER }}

    strategy:
      matrix:
        include:
        - VER: '17 2022'
          os: 'windows-2025'

    env:
      BUILD_SYS: Visual Studio ${{ matrix.VER }}
      SWIG_INSTALL_PATH: C:\Tools\swig

    steps:
    - name: Machine Info
      shell: powershell
      run: |
          systeminfo | findstr /B /C:"OS Name" /B /C:"OS Version"

    - name: Checkout
      uses: actions/checkout@v4
      with:
        show-progress: false

    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Install CCache
      uses: hendrikmuhs/ccache-action@v1
      with:
        key: ${{ matrix.os }}

    - name: Install NuGet Packages
      shell: powershell
      run: |
          nuget install PCRE2 -OutputDirectory C:\Tools
          nuget install Bison -OutputDirectory C:\Tools

    # https://cygwin.com/cygwin-ug-net/cygpath.html
    - name: Prepare Environment
      shell: bash
      run: |
          cat << EOF >> $GITHUB_ENV
          PCRE2_PATH=$(cygpath -w "$(ls -d /C/Tools/PCRE2*)")
          EOF
          BISON_PATH=$(cygpath -w "$(ls -d /C/Tools/Bison*)/bin")
          echo "$BISON_PATH" >> $GITHUB_PATH

    - name: Configure
      shell: powershell
      run: |
          cmake --version
          cmake -G "$env:BUILD_SYS" -A x64 `
          -DCMAKE_INSTALL_PREFIX="$env:SWIG_INSTALL_PATH" `
          -DCMAKE_C_FLAGS="/W3 /EHsc /DPCRE2_STATIC" `
          -DCMAKE_CXX_FLAGS="/W3 /EHsc /DPCRE2_STATIC" `
          -DPCRE2_INCLUDE_DIR="$env:PCRE2_PATH\include" `
          -DPCRE2_LIBRARY="$env:PCRE2_PATH\lib\pcre2-8-static.lib" `
          -DLINK_FLAGS="/NODEFAULTLIB:MSVCRT" -S . -B .

    - name: Build
      shell: powershell
      run: |
          cmake --build . --config Release

    - name: Test
      shell: powershell
      run: |
          ctest --output-on-failure -V -C Release

    - name: Install
      id: install-swig
      shell: powershell
      run: |
          cmake --install .
          $versionOutput = & "$env:SWIG_INSTALL_PATH\bin\swig.exe" -version
          Write-Host $versionOutput
          
          # Extract version number (e.g., "SWIG Version 4.2.0" -> "4.2.0")
          $version = ($versionOutput | Select-String -Pattern "SWIG Version (\d+\.\d+\.\d+)").Matches.Groups[1].Value
          echo "SWIG_VERSION=$version" >> $env:GITHUB_OUTPUT

    - name: Install Azure DevOps CLI Extension
      shell: powershell
      run: |
          az extension add --name azure-devops

    - name: Get Azure DevOps Token
      id: get-devops-token
      shell: bash
      run: |
        TOKEN=$(az account get-access-token \
          --resource 499b84ac-1321-427f-aa17-267ca6975798 \
          --query accessToken -o tsv)
        echo "::add-mask::$TOKEN"
        echo "ADO_TOKEN=$TOKEN" >> $GITHUB_OUTPUT

    - name: Publish Universal Package
      shell: powershell
      env:
        SWIG_VERSION: ${{ steps.install-swig.outputs.SWIG_VERSION }}
        AZURE_DEVOPS_EXT_PAT: ${{ steps.get-devops-token.outputs.ADO_TOKEN }}
      run: |
          $packageName = "swig-windows-tm"
          $packageVersion = "$env:SWIG_VERSION-${{ github.sha }}"
          
          # Create a description file
          $description = "SWIG Windows build using Visual Studio ${{ matrix.VER }} - Built from commit ${{ github.sha }}"
          
          az artifacts universal publish `
            --organization "https://dev.azure.com/trackman" `
            --feed Main `
            --scope organization `
            --name $packageName `
            --version $packageVersion `
            --description $description `
            --path "$env:SWIG_INSTALL_PATH"

